<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/static/style.css">
    <title>Chat</title>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
</head>
<body>

<div class="login-container" id="loginContainer">
    <h2>Enter your name</h2>
    <input id="usernameInput" placeholder="Your name">
    <button class="btn-primary" onclick="login()">Join Chat</button>
</div>

<div class="chat-wrapper" id="chatWrapper" style="display:none;">
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">My Chat App</div>
        <ul id="chat"></ul>
        <div class="chat-input">
            <input id="msg" placeholder="Type message...">
            <button class="btn-primary" onclick="sendMsg()">Send</button>
        </div>
    </div>

    <div class="online-users">
        <h3>Online Users</h3>
        <ul id="users"></ul>
    </div>
</div>

<script>
var socket = io();
var username = "";

// Login
function login() {
    username = document.getElementById("usernameInput").value.trim();
    if(username === "") username = "Guest";
    document.getElementById("loginContainer").style.display = "none";
    document.getElementById("chatWrapper").style.display = "flex";
    document.getElementById("msg").focus();
    socket.emit("join", {username: username});
}

// Leave chat on unload
window.addEventListener("beforeunload", function(){
    socket.emit("leave", {username: username});
});

// Send message
function sendMsg() {
    let msg = document.getElementById("msg").value.trim();
    if(msg === "") return;
    socket.send({username: username, msg: msg});
    document.getElementById("msg").value = "";
    document.getElementById("msg").focus();
}

// Enter key
document.getElementById("usernameInput").addEventListener("keydown", e => { if(e.key==="Enter") login(); });
document.getElementById("msg").addEventListener("keydown", e => { if(e.key==="Enter") sendMsg(); });

// Update online users
socket.on("user_list", function(users){
    let ul = document.getElementById("users");
    ul.innerHTML = "";
    users.forEach(u => {
        let li = document.createElement("li");
        li.textContent = u;
        ul.appendChild(li);
    });
});

// Display messages
socket.on("message", function(data){
    let li = document.createElement("li");

    let nameDiv = document.createElement("div");
    nameDiv.className = "msg-username";
    nameDiv.textContent = data.username;

    let textDiv = document.createElement("div");
    textDiv.className = "msg-text";
    textDiv.textContent = data.msg;

    let timeDiv = document.createElement("div");
    timeDiv.className = "msg-time";
    timeDiv.textContent = data.time;

    li.appendChild(nameDiv);
    li.appendChild(textDiv);
    li.appendChild(timeDiv);

    li.className = data.username === username ? "my-msg" : "other-msg";

    document.getElementById("chat").appendChild(li);
    document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
});
</script>

</body>
</html>
